<th:block th:replace="~{layout/main-layout :: main_layout(~{::#change-password-content})}">
    <div id="change-password-content">
        <div class="max-w-4xl mx-auto">
            <div class="text-sm breadcrumbs mb-6 text-slate-500">
                <ul>
                    <li><a th:href="@{/}">Trang chủ</a></li>
                    <li><a th:href="@{/profile}">Tài khoản</a></li>
                    <li>Đổi mật khẩu</li>
                </ul>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="card bg-white shadow-xl border border-slate-100">
                        <div class="card-body p-8">
                            <h2 class="card-title text-2xl font-bold text-slate-800 mb-6">Thiết lập mật khẩu mới</h2>

                            <form th:action="@{/security/change-password}" th:object="${passwordData}" method="POST" class="space-y-5">
                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-semibold">Mật khẩu hiện tại</span></label>
                                    <input type="password" th:field="*{oldPassword}" class="input input-bordered w-full bg-slate-50 focus:border-indigo-500" placeholder="••••••••" required />
                                </div>

                                <div class="divider"></div>

                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-semibold">Mật khẩu mới</span></label>
                                    <input type="password" id="new-password" th:field="*{newPassword}"
                                           class="input input-bordered w-full bg-slate-50 focus:border-indigo-500"
                                           placeholder="••••••••" required />
                                    <progress class="progress progress-ghost w-full mt-2" value="0" max="100" id="strength-bar"></progress>
                                </div>

                                <div class="form-control w-full">
                                    <label class="label"><span class="label-text font-semibold">Xác nhận mật khẩu mới</span></label>
                                    <input type="password" th:field="*{confirmPassword}" class="input input-bordered w-full bg-slate-50 focus:border-indigo-500" placeholder="••••••••" required />
                                </div>

                                <div class="card-actions justify-end mt-8 gap-4">
                                    <a th:href="@{/profile}" class="btn btn-ghost">Hủy bỏ</a>
                                    <button type="submit" class="btn btn-primary bg-indigo-600 border-none px-8 shadow-lg">Cập nhật mật khẩu</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="card bg-indigo-900 text-white shadow-xl p-6">
                        <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Mật khẩu mạnh cần có:
                        </h3>
                        <ul class="space-y-3 text-sm text-indigo-100">
                            <li id="rule-length" class="flex items-center gap-2 transition-colors duration-300">
        <span class="icon-status">
            <svg class="h-4 w-4 opacity-50" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="5"/></svg>
        </span>
                                Tối thiểu 8 ký tự
                            </li>
                            <li id="rule-upper" class="flex items-center gap-2 transition-colors duration-300">
        <span class="icon-status">
            <svg class="h-4 w-4 opacity-50" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="5"/></svg>
        </span>
                                Ít nhất 1 chữ cái viết hoa
                            </li>
                            <li id="rule-number" class="flex items-center gap-2 transition-colors duration-300">
        <span class="icon-status">
            <svg class="h-4 w-4 opacity-50" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="5"/></svg>
        </span>
                                Ít nhất 1 chữ số
                            </li>
                            <li id="rule-special" class="flex items-center gap-2 transition-colors duration-300">
        <span class="icon-status">
            <svg class="h-4 w-4 opacity-50" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="5"/></svg>
        </span>
                                Ký tự đặc biệt (!@#$%...)
                            </li>
                        </ul>
                        <div class="mt-8 p-4 bg-indigo-800 rounded-lg text-xs italic opacity-75">
                            SentinelPay không bao giờ yêu cầu bạn cung cấp mật khẩu qua điện thoại hoặc email.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const pwdInput = document.getElementById('new-password');
            const strengthBar = document.getElementById('strength-bar');

            pwdInput.addEventListener('input', () => {
                const val = pwdInput.value;
                let strength = 0;
                if (val.length >= 8) strength += 40;
                if (/[A-Z]/.test(val)) strength += 20;
                if (/[0-9]/.test(val)) strength += 20;
                if (/[^A-Za-z0-9]/.test(val)) strength += 20;

                strengthBar.value = strength;
                strengthBar.className = 'progress w-full mt-2 ';
                if (strength < 40) strengthBar.classList.add('progress-error');
                else if (strength < 80) strengthBar.classList.add('progress-warning');
                else strengthBar.classList.add('progress-success');
            });
        </script>
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // 1. Lấy các phần tử
                const pwdInput = document.getElementById('new-password');
                const strengthBar = document.getElementById('strength-bar');

                // Kiểm tra xem đã lấy được ô input chưa
                if (!pwdInput) {
                    console.error("Không tìm thấy ô input với id='new-password'. Hãy kiểm tra lại HTML!");
                    return;
                }

                const rules = {
                    length:  { el: document.getElementById('rule-length'),  check: (val) => val.length >= 8 },
                    upper:   { el: document.getElementById('rule-upper'),   check: (val) => /[A-Z]/.test(val) },
                    number:  { el: document.getElementById('rule-number'),  check: (val) => /[0-9]/.test(val) },
                    special: { el: document.getElementById('rule-special'), check: (val) => /[^A-Za-z0-9]/.test(val) }
                };

                const checkIcon = `<svg class="h-4 w-4 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>`;
                const dotIcon = `<svg class="h-4 w-4 opacity-50" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="5"/></svg>`;

                // 2. Lắng nghe sự kiện nhập liệu
                pwdInput.addEventListener('input', function() {
                    const val = this.value;
                    let score = 0;

                    console.log("Đang nhập: " + val); // Dòng này để bạn kiểm tra trong Console (F12)

                    Object.keys(rules).forEach(key => {
                        const rule = rules[key];
                        if (!rule.el) return; // Bỏ qua nếu không tìm thấy element rule

                        const isMatched = rule.check(val);
                        const iconContainer = rule.el.querySelector('.icon-status');

                        if (isMatched) {
                            rule.el.classList.remove('text-indigo-100', 'opacity-50');
                            rule.el.classList.add('text-green-400', 'font-bold');
                            if (iconContainer) iconContainer.innerHTML = checkIcon;
                            score += 25;
                        } else {
                            rule.el.classList.add('text-indigo-100', 'opacity-50');
                            rule.el.classList.remove('text-green-400', 'font-bold');
                            if (iconContainer) iconContainer.innerHTML = dotIcon;
                        }
                    });

                    // 3. Cập nhật thanh sức mạnh
                    if (strengthBar) {
                        strengthBar.value = score;
                        strengthBar.className = 'progress w-full mt-2 ';
                        if (score <= 25) strengthBar.classList.add('progress-error');
                        else if (score <= 75) strengthBar.classList.add('progress-warning');
                        else strengthBar.classList.add('progress-success');
                    }
                });
            });
        </script>
    </div>
</th:block>